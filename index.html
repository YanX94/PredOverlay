<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>PredOverlay</title>
  <style>
@font-face {
  font-family: 'Storica';
  src: url('assets/Storica-Medium.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
}

html, body {
  margin: 0;
  padding: 0;
  background-color: rgba(0, 0, 0, 0) !important;
  font-family: 'Segoe UI', sans-serif;
  user-select: none;
  overflow: hidden;
}

#overlay-box {
  position: absolute;
  top: 50px;
  left: 50px;
  width: 300px;
  background: rgba(0, 0, 0, 0.7);
  color: #fff;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
}

#title-bar {
  padding: 8px 12px;
  background: rgba(255, 255, 255, 0.1);
  font-family: 'Storica', sans-serif;
  font-weight: bold;
  font-size: 14px;
  cursor: move;
  -webkit-app-region: drag;
}

#content {
  padding-left: 10px;
  padding-bottom: 10px;
  font-size: 16px;
}

#status {
  margin-top: 10px;
  padding: 6px 10px;
  border-radius: 8px;
  font-size: 14px;
  display: inline-block;
}

.active {
  background: rgba(0, 255, 0, 0.2);
  color: #0f0;
}

.inactive {
  background: rgba(255, 0, 0, 0.2);
  color: #f55;
}

#item-slots {
  display: flex;
  gap: 8px;
  margin-top: 168px;
  margin-left: 50px;
}
.item-slot {
  width: 64px;
  height: 64px;
  background-color: #1a1a1a;
  border: 1px solid #444;
  cursor: pointer;
}
#item-modal {
  position: absolute;
  top: 100px;
  left: 100px;
  background: #111;
  padding: 10px;
  max-width: 600px;
  max-height: 400px;
  overflow-y: auto;
  z-index: 999;
}

.skill-order {
  background: rgba(0, 0, 0, 0.7);
  border-radius: 8px;
  padding: 12px;
  width: fit-content;
  margin-left: 50px;
  margin-top:10px;
}

table {
  border-collapse: collapse;
}

td {
  width: 36px;
  height: 36px;
  text-align: center;
  vertical-align: middle;
  border: 1px solid #222;
  cursor: pointer;
  font-weight: bold;
  user-select: none;
}

.skill-icon img {
  width: 32px;
  height: 32px;
}

.skill-level {
  background-color: #a5a5a579;
  color: white;
}

#hero-modal {
  display: none;
  position: absolute;
  top: 120px;
  left: 120px;
  background: #111;
  padding: 10px;
  max-width: 600px;
  max-height: 400px;
  overflow-y: auto;
  scrollbar-width: none; /* Firefox */
  z-index: 999;
}
#hero-modal::-webkit-scrollbar {
  display: none; /* Chrome, Safari, Opera */
}
  </style>
</head>
<body>

<div id="overlay-box">
  <div id="title-bar">
    <img src="assets/ico_s.png" alt="Icon" style="margin-bottom:-2px;">
    PredOverlay
  </div>
  <div id="content">
    Interaction mode : <span id="status" class="inactive">❌ LOCKED</span><br />
    Press <strong>F8</strong> to lock / unlock overlay.
  </div>
</div>

<div id="item-slots">
  <div class="item-slot" data-index="0"></div>
  <div class="item-slot" data-index="1"></div>
  <div class="item-slot" data-index="2"></div>
  <div class="item-slot" data-index="3"></div>
  <div class="item-slot" data-index="4"></div>
  <div class="item-slot" data-index="5"></div>
  <div class="item-slot" data-index="6"></div>
</div>

<div id="item-modal" style="display:none;"></div>

<div id="hero-selector" style="margin-left:50px; margin-top:20px;">
  <button id="choose-hero-btn">Choose a hero</button>
  <span id="selected-hero" style="margin-left:10px; font-weight:bold;"></span>
  <button id="save-config-btn" style="margin-left:20px;">Save</button>
</div>
<div id="hero-modal">
  <button id="close-hero-modal" style="position:absolute;top:8px;right:12px;font-size:22px;background:none;border:none;color:#fff;cursor:pointer;z-index:1001;">✖</button>
</div>

<div class="skill-order">
  <table id="skill-table">
    <!-- Rows will be generated dynamically -->
  </table>
</div>

<script>
  const { ipcRenderer } = require('electron');

  ipcRenderer.on('update-clickable-status', (_, isClickable) => {
    const status = document.getElementById('status');
    const overlayBox = document.getElementById('overlay-box');

    if (isClickable) {
      status.className = 'active';
      status.innerText = '✅ UNLOCKED';
      overlayBox.style.display = 'block';
    } else {
      status.className = 'inactive';
      status.innerText = '❌ LOCKED';
      overlayBox.style.display = 'none';
    }
  });
</script>

<script>
  const slots = document.querySelectorAll('.item-slot');
  const modal = document.getElementById('item-modal');
  let itemsCache = [];

  slots.forEach(slot => {
    slot.addEventListener('click', async () => {
      const index = slot.dataset.index;

      if (itemsCache.length === 0) {
        try {
          const res = await fetch("assets/items.json");
          itemsCache = await res.json();
        } catch (err) {
          console.error("Erreur lors de la récupération des items :", err);
          return;
        }
      }

      modal.innerHTML = `<button id="close-item-modal" style="position:absolute;top:8px;right:12px;font-size:22px;background:none;border:none;color:#fff;cursor:pointer;z-index:1001;">✖</button>` +
        itemsCache.map(item =>
          `<img src="${item.image}" data-id="${item.id}" class="item-choice" title="${item.name}" style="width: 64px; height: 64px; margin: 4px;">`
        ).join('');
      modal.style.display = 'block';

      document.getElementById('close-item-modal').onclick = () => {
        modal.style.display = 'none';
      };

      document.querySelectorAll('.item-choice').forEach(img => {
        img.addEventListener('click', () => {
          const selected = itemsCache.find(i => i.id == img.dataset.id);
          slot.innerHTML = `<img src="${selected.image}" alt="${selected.name}" style="width: 64px; height: 64px;">`;
          modal.style.display = 'none';
        });
      });
    });
  });
</script>

<script>
  const skills = ['mouse-right', 'q', 'e', 'r'];
  const table = document.getElementById('skill-table');
  const maxLevels = 18;
  let currentLevel = 1;

  const state = Array(4).fill(null).map(() => Array(maxLevels).fill(null));

  function createTable() {
    for (let i = 0; i < skills.length; i++) {
      const row = document.createElement('tr');

      const iconCell = document.createElement('td');
      iconCell.classList.add('skill-icon');
      const img = document.createElement('img');
      img.src = `assets/${skills[i]}.png`;
      img.alt = skills[i].toUpperCase();
      iconCell.appendChild(img);
      row.appendChild(iconCell);

      for (let j = 0; j < maxLevels; j++) {
        const cell = document.createElement('td');
        cell.dataset.row = i;
        cell.dataset.col = j;
        cell.addEventListener('click', handleLeftClick);
        cell.addEventListener('contextmenu', handleRightClick);
        row.appendChild(cell);
      }

      table.appendChild(row);
    }
  }

  function handleLeftClick(e) {
    const row = parseInt(e.target.dataset.row);
    const col = parseInt(e.target.dataset.col);

    if (state[row][col] === null && currentLevel <= maxLevels) {
      state[row][col] = currentLevel;
      e.target.classList.add('skill-level');
      e.target.textContent = currentLevel++;
    }
  }

  function handleRightClick(e) {
    e.preventDefault();
    const row = parseInt(e.target.dataset.row);
    const col = parseInt(e.target.dataset.col);

    if (state[row][col] !== null) {
      const removed = state[row][col];
      state[row][col] = null;
      e.target.classList.remove('skill-level');
      e.target.textContent = '';

      for (let i = 0; i < state.length; i++) {
        for (let j = 0; j < state[i].length; j++) {
          if (state[i][j] && state[i][j] > removed) {
            state[i][j] -= 1;
            const cell = document.querySelector(`[data-row="${i}"][data-col="${j}"]`);
            cell.textContent = state[i][j];
          }
        }
      }

      currentLevel -= 1;
    }
  }

  createTable();
</script>

<script>
let heroesCache = [];
let selectedHero = null;

const heroBtn = document.getElementById('choose-hero-btn');
const heroModal = document.getElementById('hero-modal');
const selectedHeroSpan = document.getElementById('selected-hero');

// Charge la liste locale des héros
async function loadHeroes() {
  if (heroesCache.length === 0) {
    try {
      const res = await fetch("assets/heroes.json");
      heroesCache = await res.json();
    } catch (err) {
      console.error("Erreur lors du chargement des héros :", err);
      heroesCache = []; // fallback vide
    }
  }
}

// Ouvre le modal de sélection de héros
heroBtn.addEventListener('click', async () => {
  await loadHeroes();

  heroModal.innerHTML = `<button id="close-hero-modal" style="position:absolute;top:8px;right:12px;font-size:22px;background:none;border:none;color:#fff;cursor:pointer;z-index:1001;">✖</button>` +
    heroesCache.map(hero =>
      `<img src="${hero.image}" data-id="${hero.id}" title="${hero.display_name || hero.name}" class="hero-choice" style="width:64px;height:64px;margin:6px;border-radius:8px;cursor:pointer;border:2px solid #222;">`
    ).join('');
  heroModal.style.display = 'block';

  document.getElementById('close-hero-modal').onclick = () => {
    heroModal.style.display = 'none';
  };

  document.querySelectorAll('.hero-choice').forEach(img => {
    img.addEventListener('click', () => {
      selectedHero = heroesCache.find(h => h.id == img.dataset.id);
      selectedHeroSpan.textContent = selectedHero.display_name || selectedHero.name;
      selectedHeroSpan.style.color = "#0ff";
      heroModal.style.display = 'none';
    });
  });
});

// Fermer le modal si on clique en dehors
document.addEventListener('click', (e) => {
  if (heroModal.style.display === 'block' && !heroModal.contains(e.target) && e.target !== heroBtn) {
    heroModal.style.display = 'none';
  }
});
</script>